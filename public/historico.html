<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hist√≥rico - Podcast Battle</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
  }
  
  .header {
    text-align: center;
    margin-bottom: 2rem;
    padding: 2rem 0;
  }
  
  .back-button {
    position: fixed;
    top: 1rem;
    left: 1rem;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
    padding: 12px 20px;
    border-radius: 25px;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    font-weight: 600;
    z-index: 1000;
  }
  
  .back-button:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
  }
  
  .table-container {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 1.5rem;
    overflow-x: auto;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  
  th, td {
    padding: 15px 12px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  th {
    background: rgba(255, 255, 255, 0.1);
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  tr:hover {
    background: rgba(255, 255, 255, 0.05);
  }
  
  /* Mobile responsive design */
  @media (max-width: 768px) {
    .container {
      padding: 0.5rem;
    }
    
    .header {
      padding: 1rem 0;
      margin-bottom: 1rem;
    }
    
    .back-button {
      position: relative;
      top: auto;
      left: auto;
      margin-bottom: 1rem;
      display: inline-block;
    }
    
    .table-container {
      padding: 1rem;
      border-radius: 15px;
    }
    
    table {
      font-size: 0.85rem;
    }
    
    th, td {
      padding: 10px 8px;
    }
    
    /* Hide some columns on mobile */
    .mobile-hide {
      display: none;
    }
    
    /* Make action buttons stack vertically on mobile */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .action-buttons button {
      width: 100%;
      font-size: 0.8rem;
      padding: 8px 12px;
    }
  }
  
  @media (max-width: 480px) {
    .table-container {
      padding: 0.5rem;
    }
    
    table {
      font-size: 0.8rem;
    }
    
    th, td {
      padding: 8px 6px;
    }
    
    /* Further hide columns on very small screens */
    .very-mobile-hide {
      display: none;
    }
  }
  
  .rating {
    font-weight: bold;
    color: #ffd700;
    font-size: 1.1rem;
  }
  
  .no-rating {
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
  }
  
  .notify-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }
  
  .notify-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }
  
  .notify-btn:disabled {
    background: rgba(255, 255, 255, 0.2);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  .rate-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    margin-right: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
  }
  
  .rate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
  }
  
  .rate-btn:disabled {
    background: rgba(255, 255, 255, 0.2);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  .clear-btn {
    background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
  }
  
  .clear-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
  }
  
  .clear-btn:disabled {
    background: rgba(255, 255, 255, 0.2);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  .loading {
    text-align: center;
    padding: 3rem 2rem;
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
  }
  
  .loading p {
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  .error {
    text-align: center;
    padding: 3rem 2rem;
    color: #ff6b6b;
    font-size: 1.1rem;
  }
  
  .error p {
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  /* Add some animation to loading */
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  .loading p {
    animation: pulse 2s infinite;
  }
</style>
</head>
<body>

<div class="container">
  <a href="/" class="back-button">‚Üê Voltar</a>

  <div class="header">
    <h1 id="podcast-title">Hist√≥rico do Podcast</h1>
    <p id="podcast-subtitle">Carregando epis√≥dios...</p>
  </div>

  <div class="table-container">
    <div id="loading" class="loading">
      <p>üîÑ A carregar epis√≥dios...</p>
    </div>
    
    <div id="error" class="error" style="display: none;">
      <p>‚ùå Erro ao carregar epis√≥dios</p>
    </div>
    
    <table id="episodes-table" style="display: none;">
      <thead>
        <tr>
          <th>Epis√≥dio</th>
          <th class="mobile-hide">T√≠tulo</th>
          <th class="very-mobile-hide">Data</th>
          <th>Pedro</th>
          <th>Jo√£o</th>
          <th>Avaliar</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="episodes-tbody">
      </tbody>
    </table>
  </div>
</div>

<script>
let currentUser = localStorage.getItem('podcastUser');
let podcastId = null;
let podcastName = null;

// Obter par√¢metros da URL
function getUrlParams() {
  const urlParams = new URLSearchParams(window.location.search);
  podcastId = urlParams.get('id');
  podcastName = urlParams.get('nome');
  
  if (!podcastId || !podcastName) {
    showError('Par√¢metros inv√°lidos na URL');
    return false;
  }
  
  document.getElementById('podcast-title').textContent = `Hist√≥rico: ${decodeURIComponent(podcastName)}`;
  document.getElementById('podcast-subtitle').textContent = `Epis√≥dios de ${decodeURIComponent(podcastName)}`;
  return true;
}

// Mostrar erro
function showError(message) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'block';
  document.getElementById('error').querySelector('p').textContent = message;
}

// Carregar epis√≥dios
async function loadEpisodes() {
  try {
    const response = await fetch(`/api/episodes/${podcastId}`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.episodes || data.episodes.length === 0) {
      showError('Nenhum epis√≥dio encontrado para este podcast');
      return;
    }
    
    displayEpisodes(data.episodes);
    
  } catch (error) {
    console.error('Error loading episodes:', error);
    showError('Erro ao carregar epis√≥dios: ' + error.message);
  }
}

// Mostrar epis√≥dios na tabela
function displayEpisodes(episodes) {
  const tbody = document.getElementById('episodes-tbody');
  tbody.innerHTML = '';
  
  episodes.forEach(episode => {
    const row = document.createElement('tr');
    
    const pedroRating = episode.ratingPedro;
    const joaoRating = episode.ratingJoao;
    const myRating = currentUser === 'Pedro' ? pedroRating : joaoRating;
    
    row.innerHTML = `
      <td><strong>#${episode.numero}</strong></td>
      <td class="mobile-hide">${episode.titulo}</td>
      <td class="very-mobile-hide">${formatDate(episode.data_publicacao)}</td>
      <td class="rating">${pedroRating ? pedroRating + '/10' : '<span class="no-rating">N/A</span>'}</td>
      <td class="rating">${joaoRating ? joaoRating + '/10' : '<span class="no-rating">N/A</span>'}</td>
      <td>
        <div class="action-buttons">
          <button class="rate-btn" onclick="rateEpisode(${episode.id}, ${episode.numero}, '${episode.titulo.replace(/'/g, "\\'")}', ${myRating})" 
                  ${!currentUser ? 'disabled' : ''}>
            ${myRating ? 'Alterar' : 'Avaliar'}
          </button>
          ${myRating ? `<button class="clear-btn" onclick="clearRating(${episode.id}, ${episode.numero}, '${episode.titulo.replace(/'/g, "\\'")}')" 
                  ${!currentUser ? 'disabled' : ''}>
            Limpar
          </button>` : ''}
        </div>
      </td>
      <td>
        <button class="notify-btn" onclick="sendNotification(${episode.numero}, '${episode.titulo.replace(/'/g, "\\'")}', ${pedroRating}, ${joaoRating})" 
                ${!currentUser ? 'disabled' : ''}>
          Notificar
        </button>
      </td>
    `;
    
    tbody.appendChild(row);
  });
  
  // Mostrar tabela e esconder loading
  document.getElementById('loading').style.display = 'none';
  document.getElementById('episodes-table').style.display = 'table';
}

// Formatar data
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('pt-PT', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

// Avaliar epis√≥dio
async function rateEpisode(episodeId, episodeNumber, episodeTitle, currentRating) {
  if (!currentUser) {
    Swal.fire({
      title: 'Erro!',
      text: 'Precisas de estar logado para avaliar',
      icon: 'error'
    });
    return;
  }
  
  const result = await Swal.fire({
    title: `Avaliar Ep #${episodeNumber}`,
    html: `
      <div style="text-align: center; margin: 20px 0;">
        <h4>${episodeTitle}</h4>
        <div style="margin: 20px 0;">
          <label for="rating-slider" style="display: block; margin-bottom: 10px; font-weight: bold;">
            A tua avalia√ß√£o (1-10):
          </label>
          <input type="range" id="rating-slider" min="1" max="10" value="${currentRating || 5}" 
                 style="width: 100%; margin: 10px 0;">
          <div id="rating-value" style="font-size: 18px; font-weight: bold; color: #ffd700;">
            ${currentRating || 5}/10
          </div>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: currentRating > 0 ? 'Alterar' : 'Avaliar',
    cancelButtonText: 'Cancelar',
    allowOutsideClick: false,
    didOpen: () => {
      const slider = document.getElementById('rating-slider');
      const value = document.getElementById('rating-value');
      
      slider.addEventListener('input', (e) => {
        value.textContent = e.target.value + '/10';
      });
    }
  });
  
  if (result.isConfirmed) {
    const rating = parseInt(document.getElementById('rating-slider').value);
    
    try {
      const response = await fetch('/api/rate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          podcastId: podcastId,
          episodeId: episodeId,
          user: currentUser,
          rating: rating
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      Swal.fire({
        title: 'Avalia√ß√£o guardada!',
        text: `Avaliaste o Ep #${episodeNumber} com ${rating}/10`,
        icon: 'success',
        timer: 2000,
        showConfirmButton: false
      });
      
      // Recarregar epis√≥dios para mostrar a nova avalia√ß√£o
      await loadEpisodes();
      
    } catch (error) {
      console.error('Error rating episode:', error);
      Swal.fire({
        title: 'Erro!',
        text: 'Erro ao guardar avalia√ß√£o: ' + error.message,
        icon: 'error'
      });
    }
  }
}

// Limpar avalia√ß√£o
async function clearRating(episodeId, episodeNumber, episodeTitle) {
  if (!currentUser) {
    Swal.fire({
      title: 'Erro!',
      text: 'Precisas de estar logado para limpar avalia√ß√£o',
      icon: 'error'
    });
    return;
  }
  
  const result = await Swal.fire({
    title: 'Limpar avalia√ß√£o',
    text: `Tens a certeza que queres limpar a tua avalia√ß√£o do Ep #${episodeNumber}?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Sim, limpar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#dc3545'
  });
  
  if (result.isConfirmed) {
    try {
      const response = await fetch('/api/rate', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          podcastId: podcastId,
          episodeId: episodeId,
          user: currentUser
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      Swal.fire({
        title: 'Avalia√ß√£o removida!',
        text: `Removeste a tua avalia√ß√£o do Ep #${episodeNumber}`,
        icon: 'success',
        timer: 2000,
        showConfirmButton: false
      });
      
      // Recarregar epis√≥dios para mostrar a mudan√ßa
      await loadEpisodes();
      
    } catch (error) {
      console.error('Error clearing rating:', error);
      Swal.fire({
        title: 'Erro!',
        text: 'Erro ao limpar avalia√ß√£o: ' + error.message,
        icon: 'error'
      });
    }
  }
}

// Enviar notifica√ß√£o
async function sendNotification(episodeNumber, episodeTitle, pedroRating, joaoRating) {
  if (!currentUser) {
    Swal.fire({
      title: 'Erro!',
      text: 'Precisas de estar logado para enviar notifica√ß√µes',
      icon: 'error'
    });
    return;
  }
  
  const otherUser = currentUser === 'Pedro' ? 'Jo√£o' : 'Pedro';
  const myRating = currentUser === 'Pedro' ? pedroRating : joaoRating;
  const otherRating = currentUser === 'Pedro' ? joaoRating : pedroRating;
  
  // Verificar se h√° ratings para notificar
  if (myRating === 0 && otherRating === 0) {
    Swal.fire({
      title: 'Aviso!',
      text: 'Nenhum de voc√™s avaliou este epis√≥dio ainda',
      icon: 'info'
    });
    return;
  }
  
  const result = await Swal.fire({
    title: `Notificar sobre Ep #${episodeNumber}`,
    html: `
      <div style="text-align: center; margin: 20px 0;">
        <h4>${episodeTitle}</h4>
        <div style="margin: 15px 0;">
          ${myRating > 0 ? `<div><strong>A tua nota:</strong> ${myRating}/10</div>` : ''}
          ${otherRating > 0 ? `<div><strong>${otherUser}:</strong> ${otherRating}/10</div>` : ''}
        </div>
        <div style="margin-top: 20px;">
          <textarea id="notification-message" placeholder="Escreve uma mensagem para ${otherUser}..." 
                    style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"></textarea>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Enviar',
    cancelButtonText: 'Cancelar',
    allowOutsideClick: false
  });
  
  if (result.isConfirmed) {
    const message = document.getElementById('notification-message').value;
    
    if (!message.trim()) {
      Swal.fire({
        title: 'Erro!',
        text: 'Escreve uma mensagem para enviar',
        icon: 'error'
      });
      return;
    }
    
    try {
      // Enviar notifica√ß√£o via API
      const response = await fetch('/api/notify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          targetUser: otherUser,
          podcastName: `${decodeURIComponent(podcastName)} - Ep ${episodeNumber}`,
          rating: myRating || otherRating,
          message: message,
          fromUser: currentUser,
          podcastId: podcastId
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      Swal.fire({
        title: 'Notifica√ß√£o enviada!',
        text: `Enviaste uma notifica√ß√£o para ${otherUser} sobre o Ep #${episodeNumber}`,
        icon: 'success',
        timer: 3000,
        showConfirmButton: false
      });
      
    } catch (error) {
      console.error('Error sending notification:', error);
      Swal.fire({
        title: 'Erro!',
        text: 'Erro ao enviar notifica√ß√£o: ' + error.message,
        icon: 'error'
      });
    }
  }
}

// Inicializar p√°gina
(async () => {
  if (!getUrlParams()) {
    return;
  }
  
  if (!currentUser) {
    showError('Precisas de estar logado para ver o hist√≥rico');
    return;
  }
  
  await loadEpisodes();
})();
</script>

</body>
</html>
